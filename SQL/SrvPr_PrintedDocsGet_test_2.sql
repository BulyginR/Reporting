--EXEC WH1.[SrvPr_PrintedDocsGet] 
declare @mode varchar(10)
set @mode = 'new'



declare @DOCS varchar(max)
set @DOCS = '0001226517/1#PackCase|0001226517/1#PackCaseList|0001226517/2#PackCase|0001226517/2#PackCaseList|0001226517/3#PackCase|0001226517/3#PackCaseList|0001226517/4#PackCase|0001226517/4#PackCaseList|0001226517/5#PackCase|0001226517/5#PackCaseList|0001226517/6#PackCase|0001226517/6#PackCaseList|0001226517/7#PackCase|0001226517/7#PackCaseList|0001226517/8#PackCase|0001226517/8#PackCaseList|0001226517/9#PackCase|0001226517/9#PackCaseList|0001226517/10#PackCase|0001226517/10#PackCaseList|0001226517/11#PackCase|0001226517/11#PackCaseList|0001226517/12#PackCase|0001226517/12#PackCaseList|0001226517/13#PackCase|0001226517/13#PackCaseList|0001226517/14#PackCase|0001226517/14#PackCaseList|0001226517/15#PackCase|0001226517/15#PackCaseList|0001226517/16#PackCase|0001226517/16#PackCaseList|0001226517/17#PackCase|0001226517/17#PackCaseList|0001226517/18#PackCase|0001226517/18#PackCaseList|0001226517/19#PackCase|0001226517/19#PackCaseList|0001226517/20#PackCase|0001226517/20#PackCaseList|0001226517/21#PackCase|0001226517/21#PackCaseList|0001226517/22#PackCase|0001226517/22#PackCaseList|0001226517/23#PackCase|0001226517/23#PackCaseList|0001226517/24#PackCase|0001226517/24#PackCaseList|0001226517/25#PackCase|0001226517/25#PackCaseList|0001226517/26#PackCase|0001226517/26#PackCaseList'


if object_id('tempdb..#tmp') is not null drop table #tmp
if object_id('tempdb..#tmp_log') is not null drop table #tmp_log
SELECT 
	 ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS IDENT,
	 cast(SUBSTRING(ITEM,1,CASE WHEN CHARINDEX('#',ITEM)>0 THEN CHARINDEX('#',ITEM)-1 ELSE 0 END) as varchar(500)) AS DOCNUMBER,
	 cast(SUBSTRING(ITEM,CHARINDEX('#',ITEM)+1, LEN(ITEM)) as varchar(500)) AS REPORTNAME
into #tmp
FROM PRD1.DBO.SPLITLIST(@DOCS,'|')

if @mode = 'new'
begin
	 select 
	 PL1.*
	 into #tmp_log
	 FROM  wh1.SrvPr_PRINTLOG PL1 WITH(NOLOCK) where DOCNUMBER in (select DOCNUMBER from #tmp)
		  -- INNER JOIN #tmp D ON PL1.DOCNUMBER=D.DOCNUMBER AND PL1.REPORTNAME=D.REPORTNAME

	 SELECT 
	 D.IDENT, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 1 AND PL1.PRINTFORMAT = 0 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS ORIGINALS, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 0 AND PL1.PRINTFORMAT = 0 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS COPIES, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 1 AND PL1.PRINTFORMAT = 1 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS ORIGINALSEXPORTPDF, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 0 AND PL1.PRINTFORMAT = 1 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS COPIESEXPORTPDF, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 1 AND PL1.PRINTFORMAT = 2 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS ORIGINALSEXPORTXLS, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 0 AND PL1.PRINTFORMAT = 2 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS COPIESEXPORTXLS 
	 FROM #tmp D
		  LEFT JOIN #tmp_log PL1/*wh1.SrvPr_PRINTLOG PL1 WITH(NOLOCK)*/ ON PL1.DOCNUMBER=D.DOCNUMBER AND PL1.REPORTNAME=D.REPORTNAME
	 GROUP BY D.IDENT ORDER BY D.IDENT 
end
else

	 SELECT 
	 D.IDENT, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 1 AND PL1.PRINTFORMAT = 0 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS ORIGINALS, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 0 AND PL1.PRINTFORMAT = 0 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS COPIES, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 1 AND PL1.PRINTFORMAT = 1 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS ORIGINALSEXPORTPDF, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 0 AND PL1.PRINTFORMAT = 1 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS COPIESEXPORTPDF, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 1 AND PL1.PRINTFORMAT = 2 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS ORIGINALSEXPORTXLS, 
	 ISNULL(SUM(CASE WHEN ISNULL(PL1.REPORTNAME,'')<>'' AND PL1.ORIGINAL = 0 AND PL1.PRINTFORMAT = 2 THEN PL1.PRINTAMOUNT ELSE 0 END),0) AS COPIESEXPORTXLS 
	 FROM #tmp D
		  /*(SELECT 
				ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS IDENT,
				SUBSTRING(ITEM,1,CASE WHEN CHARINDEX('#',ITEM)>0 THEN CHARINDEX('#',ITEM)-1 ELSE 0 END) AS DOCNUMBER,
				SUBSTRING(ITEM,CHARINDEX('#',ITEM)+1, LEN(ITEM)) AS REPORTNAME
		  FROM PRD1.DBO.SPLITLIST(@DOCS,'|')
		  ) D*/
		  LEFT JOIN wh1.SrvPr_PRINTLOG PL1 WITH(NOLOCK) ON PL1.DOCNUMBER=D.DOCNUMBER AND PL1.REPORTNAME=D.REPORTNAME
	 GROUP BY D.IDENT ORDER BY D.IDENT 
